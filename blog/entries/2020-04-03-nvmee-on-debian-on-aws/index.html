<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="stylesheet" href="/static/gen/style.css">
<link rel="stylesheet" href="/static/pygments.css">
<meta property="og:site_name" content="Creative Commons" />
<meta property="og:title" content="NVMEe on Debian on AWS" />



<meta property="og:description" content="Problem" />


<meta property="og:url" content="/blog/entries/2020-04-03-nvmee-on-debian-on-aws/" />
<meta property="og:type" content="article" />


  
  

  
    
  

  
    
    
  

  

  <meta property="og:image" content="https://cc-og-image.vercel.app/NVMEe on Debian on AWS.png?&amp;md=1&amp;fontFamily=roboto-condensed&amp;fontSize=100px&amp;images=https%3A%2F%2Fcc-vocabulary.netlify.app%2Flogos%2Fproducts%2Fopen_source.svg%23opensource" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="NVMEe on Debian on AWS">
<meta name="twitter:description" content="Problem">

<meta name="twitter:site" content="@creativecommons">
<meta name="twitter:creator" content="@creativecommons">
<meta name="monetization" content="$ilp.uphold.com/edR8erBDbRyq">
<script src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
  integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
  integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script type="text/javascript" src="/static/gen/script.js"></script>
<script src="https://unpkg.com/@creativecommons/vocabulary@2020.7.2/js/vocabulary.js"></script>
<script>
  const globalHeaderInstance = vocabulary.createGlobalHeader();
</script>
<title>NVMEe on Debian on AWS — Creative Commons Open Source</title>

<body>

  <!-- Header -->
  <header class="container">
    <nav class="navbar">
      <div class="navbar-brand">
        <a class="has-text-black" href="/">
          <svg
            class="logo margin-top-small"
            xmlns="http://www.w3.org/2000/svg"
            preserveAspectRatio="xMidYMid meet"
            viewBox="0 0 284 46">
            <use href="#opensource"></use>
          </svg>
        </a>
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu">
        <div class="navbar-end">
          <a class="navbar-item  is-active" href="/blog/entries/">
            Blog
          </a>
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link is-arrowless " tabindex="0">
              Contribute<i class="icon caret-down"></i></a>
            <div class="navbar-dropdown">
              
                <a class="navbar-item" href="/contributing-code/">Contribution Guidelines</a>
              
                <a class="navbar-item" href="/contributing-code/projects/">Project List</a>
              
                <a class="navbar-item" href="/contributing-code/issue-finder/">Issue Finder</a>
              
                <a class="navbar-item" href="/contributing-code/pr-guidelines/">Pull Request Guidelines</a>
              
                <a class="navbar-item" href="/contributing-code/github-repo-guidelines/">GitHub Repo Guidelines</a>
              
                <a class="navbar-item" href="/contributing-code/repo-labels/">Repository Labels</a>
              
                <a class="navbar-item" href="/contributing-code/javascript-guidelines/">JavaScript Guidelines</a>
              
                <a class="navbar-item" href="/contributing-code/python-guidelines/">Python Guidelines</a>
              
                <a class="navbar-item" href="/contributing-code/translation-guide/">Translation Guide</a>
              
                <a class="navbar-item" href="/contributing-code/usability/">Usability</a>
              
            </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link is-arrowless " tabindex="0">
              Community<i class="icon caret-down"></i></a>
            <div class="navbar-dropdown is-active">
              
                <a class="navbar-item" href="/community/">Join the Community</a>
              
                <a class="navbar-item" href="/community/community-team/">Community Team</a>
              
                <a class="navbar-item" href="/community/community-team/members/">Community Team Members</a>
              
                <a class="navbar-item" href="/community/community-team/project-roles/">Project Roles</a>
              
                <a class="navbar-item" href="/community/community-team/community-building-roles/">Community Building Roles</a>
              
                <a class="navbar-item" href="/community/write-a-blog-post/">Write a Blog Post</a>
              
                <a class="navbar-item" href="/community/code-of-conduct/">Code of Conduct</a>
              
                <a class="navbar-item" href="/community/code-of-conduct/enforcement/">Code of Conduct Enforcement</a>
              
            </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link is-arrowless " tabindex="0">
              Work Programs<i class="icon caret-down"></i></a>
            <div class="navbar-dropdown">
              
                <a class="navbar-item" href="/programs/">Overview</a>
              
                <a class="navbar-item" href="/programs/project-ideas/">Project Ideas</a>
              
                <a class="navbar-item" href="/programs/applicant-guide/">Applicant Guide</a>
              
                <a class="navbar-item" href="/programs/contrib-guide/">Contributor Guide</a>
              
                <a class="navbar-item" href="/programs/lead-guide/">Project Lead Guide</a>
              
                <a class="navbar-item" href="/programs/history/">History</a>
              
            </div>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Breadcrumb -->
  
    <div class="breadcrumb-container">
      <nav class="container breadcrumb caption bold" aria-label="breadcrumbs">
        <ul>
          
          
          <!-- Extracting the slugs of URL -->
          
            
              
              
            
          
            
              
              
            
          
            
              
              
            
          
            
              
              
            
          
          
            <!-- Active link -->
            
              <!-- Forming the URL using extracted slugs -->
              
              
              
                
              
              <li><a class="link" href="/">
              
                Home
              
              </a></li>
            
          
            <!-- Active link -->
            
              <!-- Forming the URL using extracted slugs -->
              
              
              
                
              
                
              
              <li><a class="link" href="/blog/">
              
                Blog
              
              </a></li>
            
          
            <!-- Active link -->
            
              <!-- Forming the URL using extracted slugs -->
              
              
              
                
              
                
              
                
              
              <li><a class="link" href="/blog/entries/">
              
                Entries
              
              </a></li>
            
          
            <!-- Active link -->
            
              <li class="is-active"><a aria-current="page displayed">NVMEe on Debian on AWS</a></li>
            
          
        </ul>
      </nav>
    </div>
  

  <!-- Body -->
  
  <div class="single-post">
    <header class="single-post-header">
      <div class="container">
        <h4>CC Open Source Blog</h4>
        <h2 class="title">NVMEe on Debian on AWS</h2>
        <div class="author columns is-marginless">
          <header>
      <figure class="image blog-image">
        <img class="profile" src="https://secure.gravatar.com/avatar/5324367e4af9d821ff3b388c04c42e7e?size=200&d=mp" alt="gravatar" />
      </figure>
    </header>
          <p class="padding-small">
            by <a class="author-name" href="/blog/authors/TimidRobot/">Timid Robot Zehta</a> on 2020-04-03
          </p>
        </div>
        
      </div>
    </header>
    <div class="single-post-body content container">
      <h2 id="problem">Problem</h2><p>The current Creative Commons infrastructure buildouts use Debian GNU/Linux AWS
EC2 instances with EBS volumes. Depending on chance (or race conditions), the
mapping of block devices can be different from one host to another or between
reboots.</p>
<blockquote><p><em>Occasionally, devices can respond to discovery in a different order in
subsequent instance starts, which causes the device name to change.</em>
(<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/nvme-ebs-volumes.html" title="Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute Cloud">Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute
Cloud</a>)</p>
</blockquote>
<h2 id="our-solution">Our Solution</h2><p>Modern Amazon Linux AMIs resolve this by providing a <code>udev</code> rule, but Debian
GNU/Linux does not yet do this. To ensure our systems are configured correctly,
At Creative Commons, we use the device specified during provisioning (ex.
<code>/dev/xvdf</code>) to identify the correct NVMEe device. We then format it with a
label that can be used mounting during subsequent reboots.</p>
<p>Thankfully, AWS documents the the device specified during provisioning (ex. <code>/dev/xvdf</code>):</p>
<blockquote><p><em>For Nitro-based instances, the block device mappings that are specified in
the Amazon EC2 console when you are attaching an EBS volume or during
AttachVolume or RunInstances API calls are captured in the vendor-specific
data field of the NVMe controller identification.</em>
(<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/nvme-ebs-volumes.html" title="Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute Cloud">Amazon EBS and NVMe on Linux Instances - Amazon Elastic Compute
Cloud</a>)</p>
</blockquote>
<p>We use SaltStack (<a href="https://github.com/creativecommons/sre-salt-prime" title="creativecommons/sre-salt-prime: Site Reliability Engineering / DevOps SaltStack configuration files"><code>creativecommons/sre-salt-prime</code></a>) to:</p>
<ol>
<li>Install the <code>nvme-cli</code> package</li>
<li>Use the <code>nvme</code> command to detect which <code>/dev/nvme?n?</code> contains <em>spec</em> (ex.
<code>xvdf</code>) in the NVMe vendor specific data</li>
<li>Create a symlink (ex. <code>/dev/xvdf -&gt; /dev/nvme1n1</code>) so that SaltStack can use
<code>/dev/xvdf</code> for the initial setup</li>
<li>Perform the intial setup</li>
<li>Delete the symlink since:<ol>
<li>The initial setup formatted the volume with a label that is used to mount
the filesystem</li>
<li>There is no guarantee the symlink will be accurate on subsequent reboots
and it might cause confusion</li>
</ol>
</li>
</ol>
<p>The <a href="https://github.com/creativecommons/sre-salt-prime/blob/master/states/mount/init.sls"><code>states/mount/init.sls</code></a> state includes a complex shell
command (with Jinja2 variables) that loops through the NVMe devices and finds
the correct one:</p>
<div class="hll"><pre><span></span><span class="k">for</span><span class="w"> </span>n<span class="w"> </span><span class="k">in</span><span class="w"> </span>/dev/nvme?n?
<span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>nvme<span class="w"> </span>id-ctrl<span class="w"> </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">n</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s1">&#39;^0000:.*{{ spec_short }}&#39;</span>
<span class="w">    </span><span class="k">then</span>
<span class="w">        </span>ln<span class="w"> </span>-s<span class="w"> </span><span class="si">${</span><span class="nv">n</span><span class="si">}</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span>spec_long<span class="w"> </span><span class="o">}}</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>
</pre></div>
<p>Example variable values:</p>
<table class="table table-striped">
<thead class="thead-dark"><tr>
<th>Jinja2 Variable</th>
<th>Example Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{{ spec_short }}</code></td>
<td><code>xvdf</code></td>
</tr>
<tr>
<td><code>{{ spec_long }}</code></td>
<td><code>/dev/xvdf</code></td>
</tr>
</tbody>
</table>
<h3 id="related-links">Related Links</h3><ul>
<li><a href="https://wiki.debian.org/Cloud/AmazonEC2Image/Buster" title="Cloud/AmazonEC2Image/Buster - Debian Wiki">Cloud/AmazonEC2Image/Buster - Debian Wiki</a></li>
<li><a href="https://packages.debian.org/buster/nvme-cli" title="Debian -- Details of package nvme-cli in buster"><code>nvme-cli</code> package details in Debian buster</a></li>
<li>Debian buster — Debian Manpages<ul>
<li><a href="https://manpages.debian.org/buster/nvme-cli/nvme.1.en.html">nvme(1) — nvme-cli</a><ul>
<li><a href="https://manpages.debian.org/buster/nvme-cli/nvme-id-ctrl.1.en.html">nvme-id-ctrl(1) — nvme-cli</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="other-solutions">Other Solutions</h2><p>While doing additional research for this blog post, I found additional
solutions to the same problem. They're all good, but I apprecite the simplicity
of a temporary symlink for setup versus maintaining custom udev rules (maybe I
can help contribute a udev based solution to Debian or Debian's EC2 image). I
can also easily imagine a more complex solution being a better fit if/when our
infrastructure provisioining become more complex.</p>
<ul>
<li><a href="https://github.com/oogali/ebs-automatic-nvme-mapping" title="oogali/ebs-automatic-nvme-mapping: Automatic mapping of EBS volumes via NVMe block devices to standard block device paths">oogali/ebs-automatic-nvme-mapping</a>: Automatic mapping of EBS volumes via NVMe block devices to standard block device paths<ul>
<li>udev rule that invokes a Bash script to create symlinks</li>
</ul>
</li>
<li>CoreOS<ul>
<li>udev rules that invokes a Bash script to create symlinks<ul>
<li><a href="https://github.com/coreos/init/blob/master/udev/rules.d/90-cloud-storage.rules"><code>udev/rules.d/90-cloud-storage.rules</code></a></li>
<li><a href="https://github.com/coreos/init/blob/master/udev/bin/cloud_aws_ebs_nvme_id"><code>udev/bin/cloud_aws_ebs_nvme_id</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="https://gist.github.com/jalaziz/c22c8464cb602bc2b8d0a339b013a9c4">AWS EBS NVMe udev rules</a><ul>
<li>udev rule that invokes a Pyton script to create symlinks</li>
<li>this is a copy as Amazon only provides access to the source of Amazon Linux
from within an Amazon Linux AMI: <em>The yumdownloader --source command line
tool provided in the Amazon Linux AMI enables viewing of source code inside
of an Amazon EC2.</em> (<a href="https://aws.amazon.com/amazon-linux-ami/faqs/" title="Amazon Linux AMI FAQs">Amazon Linux AMI FAQs</a>)</li>
</ul>
</li>
</ul>

    </div>
    <footer class="single-post-footer container">
      <div class="category">
        <h4 class="category-title">Categories</h4>
        <div class="categories">
          
            
              
              
              <a class="button tag" href=" /blog/categories/open-source/ ">open-source</a>
            
              
              
              <a class="button tag" href=" /blog/categories/SaltStack/ ">SaltStack</a>
            
          
        </div>
      </div>
      
      <div class="comments">
<div id="disqus_thread"></div>
<script>
  var disqus_config = function() { this.page.identifier = "/blog/entries/2020-04-03-nvmee-on-debian-on-aws"; this.page.url = "http://opensource.creativecommons.org/blog/entries/2020-04-03-nvmee-on-debian-on-aws/"; };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//cc-open-source.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>
  Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript"
    rel="nofollow">comments powered by Disqus.</a>
</noscript>
</div>
    </footer>
  </div>


  <!-- Footer -->
  <footer class="main-footer">
    <div class="container">
      <div class="columns">
        <div class="column is-one-third-tablet-only is-one-quarter-desktop">
          <a href="https://creativecommons.org" class="main-logo margin-bottom-bigger">
            <span class="has-text-white">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                preserveAspectRatio="xMidYMid meet"
                viewBox="0 0 304 73">
                <use href="#logomark"></use>
              </svg>
            </span>
          </a>
          <div>
            <address class="margin-bottom-normal">Creative Commons<br />PO Box 1866, Mountain View CA 94042</address>
            <a href="mailto:info@creativecommons.org" class="mail">info@creativecommons.org</a><br />
            <a href="tel://+1-415-429-6753" class="phone">+1-415-429-6753</a>
          </div>
          <div class="margin-vertical-large">
            <a href="https://www.instagram.com/creativecommons" class="social has-text-white" target="_blank"
              rel="noopener">
              <i class="icon margin-right-small is-size-4">instagram</i>
            </a>
            <a href="https://www.twitter.com/creativecommons" class="social has-text-white" target="_blank"
              rel="noopener">
              <i class="icon margin-right-small is-size-4">twitter</i>
            </a>
            <a href="https://www.facebook.com/creativecommons" class="social has-text-white" target="_blank"
              rel="noopener">
              <i class="icon margin-right-small is-size-4">facebook</i>
            </a>
            <a href="https://www.linkedin.com/company/creative-commons/" class="social has-text-white" target="_blank"
              rel="noopener">
              <i class="icon margin-right-small is-size-4">linkedin</i>
            </a>
          </div>
        </div>
        <div class="column is-two-third-tablet-only is-three-quarters-desktop">
          <div class="columns">
            <div class="column is-full">
              <nav class="footer-navigation">
                <ul class="menu">
                  <li>
                    <a href="/blog/entries/" class="menu-item">Blog</a>
                  </li>
                  <li>
                    <a href="/community/community-team/" class="menu-item">Community Team</a>
                  </li>
                  <li>
                    <a href="/contributing-code/projects/" class="menu-item">Project List</a>
                  </li>
                  <li>
                    <a href="/archives/" class="menu-item">Archives</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
          <div class="columns">
            <div class="column is-two-thirds">
              <div class="subscription">
                <h5 class="b-header">Subscribe to our newsletter</h5>
                <form class="newsletter">
                  <input type="text" class="input" placeholder="Your email">
                  <input type="submit" value="subscribe" class="button small">
                </form>
              </div>
              <div class="attribution margin-top-bigger">
                <p class="caption">
                  Except where otherwise
                  <a href="https://creativecommons.org/policies#license" target="_blank" rel="noopener">noted</a>,
                  content on this site is licensed under a
                  <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">Creative Commons
                    Attribution 4.0 International license</a>.
                  <a href="https://creativecommons.org/website-icons" target="_blank" rel="noopener">Icons</a>
                  by
                  <a href="https://fontawesome.com/" target="_blank" rel="noopener">Font Awesome</a>.
                </p>
                <div class="margin-top-smaller">
                  <i class="icon margin-right-small is-size-4">cclogo</i>
                  <i class="icon margin-right-small is-size-4">ccby</i>
                </div>
              </div>
            </div>
            <div class="column is-one-third">
              <aside class="donate-section">
                <h5>Our work relies on you!</h5>
                <p>Help us keep the internet free and open.</p>
                <a class="button small donate" href="https://creativecommons.org/donate?c_src=website&c_src2=GlobalFooter">
                  <i class="icon cc-letterheart-filled margin-right-small is-size-5 padding-top-smaller"></i>
                  Donate now
                </a>
              </aside>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
</body>
